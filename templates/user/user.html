<!doctype html>
<html lang="en"
      data-layout-width="boxed"
      data-topbar="dark"
      data-preloader="disable"
      data-card-layout="borderless"
      data-bs-theme="light"
      data-topbar-image="pattern-1">
    <head>
        <meta charset="utf-8" />
        <!-- penting untuk responsive di HP -->
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            {{ if .Title }}
                {{ .Title }}
            {{ else }}
                Stock Hadiah App
            {{ end }}
        </title>

        <!-- Bootstrap Css -->
        <link href="/assets/css/bootstrap.min.css" id="bootstrap-style" rel="stylesheet" type="text/css" />
        <link href="/assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />
        <!-- Icons Css -->
        <link href="/assets/css/icons.min.css" rel="stylesheet" type="text/css" />
        <!-- App Css-->
        <link href="/assets/css/app.min.css" id="app-style" rel="stylesheet" type="text/css" />

        <!-- Plugin js (kalau perlu di-head) -->
        <script src="/assets/js/plugin.js"></script>
    </head>
    <body data-sidebar="dark">
        <div id="layout-wrapper">
            {{ template "header" . }}
            {{ template "sidebar" . }}
        </div>

        <div class="main-content">
            <div class="page-content">
                <div class="container-fluid">
					<div class="row">
                        <div class="col-12">
                            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                <h4 class="mb-sm-0 font-size-18">Users</h4>

                                <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item"><a href="#">Settings</a></li>
                                        <li class="breadcrumb-item active">Users</li>
                                    </ol>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12"> 
                            <div class="card"> 
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Daftar User</h5>
                                    <button type="button" class="btn btn-primary waves-effect btn-label waves-light" data-bs-toggle="modal" data-bs-target="#userModal">
                                        <i class="bx bx-plus label-icon"></i> New User
                                    </button>
                                </div>
                                <div class="card-body">
                                    {{ if .Error }}
                                    <div class="alert alert-danger" role="alert">
                                        {{ .Error }}
                                    </div>
                                    {{ end }}
                                    <div class="table-responsive">
                                        <table class="table table-responsive">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 50px;">#</th>
                                                    <th>Username</th>
                                                    <th>Nama</th>
                                                    <!-- <th>Email</th> -->
                                                    <th>Role</th>
                                                    <th>Store ID</th>
                                                    <th>Status</th>
                                                    <!-- <th>Created At</th> -->
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {{ range $i, $user := .users }}
                                                <tr>
                                                    <td>{{ no $i 1 }}</td>
                                                    <td>{{ $user.Username }}</td>
                                                    <td>{{ $user.Name }}</td>
                                                    <!-- <td>{{ $user.Email }}</td> -->
                                                    <td><h5><span class=" badge badge-soft-info">{{ $user.RoleDisplay }}</span></h5></td>
                                                    <td>{{ $user.StoreDisplay }}</td>
                                                    <td><h5>
                                                        {{ if eq $user.Status "active" }}
                                                            <span class="badge badge-soft-success">{{ $user.StatusLabel }}</span>
                                                        {{ else }}
                                                            <span class="badge badge-soft-secondary">{{ $user.StatusLabel }}</span>
                                                        {{ end }}
                                                        </h5>
                                                    </td>
                                                    <!-- <td>{{ $user.CreatedAtDisplay }}</td> -->
                                                    <td>
                                                        <div class="d-flex justify-content-start">
                                                        <button type="button"
                                                            class="btn btn-outline-warning waves-effect waves-light btn-sm me-1 btn-edit-user"
                                                            data-user-id="{{ $user.ID }}"
                                                            data-nip="{{ $user.NIP }}"
                                                            data-username="{{ $user.Username }}"
                                                            data-name="{{ $user.Name }}"
                                                            data-email="{{ $user.Email }}"
                                                            data-status="{{ $user.Status }}"
                                                            data-stores="{{ range $index, $sid := $user.StoreIDs }}{{ if $index }},{{ end }}{{ $sid }}{{ end }}"
                                                            data-roles="{{ range $idx, $role := $user.RoleNames }}{{ if $idx }},{{ end }}{{ $role }}{{ end }}">
                                                            <i class="bx bx-pen font-size-16 align-middle me-2"></i>Edit</button>
                                                        <button type="button" class="btn btn-outline-danger waves-effect waves-light btn-sm btn-delete-user" data-url="/users/delete/{{ $user.ID }}" data-username="{{ $user.Username }}">
                                                            <i class="bx bx-trash font-size-16 align-middle me-2"></i>Del</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {{ else }}
                                                <tr>
                                                    <td colspan="8" class="text-center">Belum ada data user</td>
                                                </tr>
                                                {{ end }}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div> 
                        </div> 
                    </div>
                </div>
            </div>
            {{ template "footer" . }}
        </div>

    <!-- Modal -->
    <div class="modal fade " id="userModal" tabindex="-1"
         aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal" id="userModalLabel">New User Form</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <form action="/users" method="post">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Name</label>
                                    <input type="text" class="form-control "
                                        id="name" name="name">
                                </div>

                                <div class="mb-3">
                                    <label for="username" class="form-label">Username Login</label>
                                    <input type="text" class="form-control "
                                        id="username" name="username">
                                </div>

                                <div class="mb-3">
                                    <label for="userPassword" class="form-label">Password</label>
                                    <input type="password" name="password" class="form-control " id="userPassword">
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control " 
                                        id="email" name="email" required>
                                </div>

                                <div class="mb-3">
                                    <label for="userRoles" class="form-label">Roles</label>
                                    <select name="roles" id="userRoles" class="form-select" multiple>
                                        {{ range .roles }}
                                            <option value="{{ .Name }}">{{ .Name }}</option>
                                        {{ end }}
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="nip" class="form-label">Nomor Identitas Pegawai</label>
                                    <input type="text" class="form-control "
                                        id="nip" name="nip" placeholder="Masukkan NIP/NIK Pegawai">
                                </div>

                                <div class="mb-3">
                                    <label for="store_id" class="form-label">Outlet MK</label>
                                    <select id="store_id" class="form-select " name="store_id" multiple required>
                                        {{ range .stores }}
                                            <option value="{{ .StoreID }}">{{ .StoreName }}</option>
                                        {{ end }}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="status" class="form-label">Aktif</label>
                                    <select id="status" class="form-select" name="status">
                                        <option value="active">Aktif</option>
                                        <option value="non_active">Non Aktif</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >Batal</button>
                        <button type="submit" class="btn btn-primary">
                            <!-- <span wire:loading wire:target="store" class="spinner-border spinner-border-sm"></span> -->
                            Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade " id="userEditModal" tabindex="-1"
         aria-labelledby="userEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal" id="userEditModalLabel">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <form action="/users/update" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="user_id" id="edit_user_id">
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="edit_name" class="form-label">Name</label>
                                    <input type="text" class="form-control " id="edit_name" name="name">
                                </div>

                                <div class="mb-3">
                                    <label for="edit_username" class="form-label">Username Login</label>
                                    <input type="text" class="form-control " id="edit_username" name="username">
                                </div>

                                <div class="mb-3">
                                    <label for="edit_userPassword" class="form-label">Password</label>
                                    <input type="password" name="password" class="form-control " id="edit_userPassword" placeholder="Kosongkan jika tidak diubah">
                                </div>

                                <div class="mb-3">
                                    <label for="edit_email" class="form-label">Email</label>
                                    <input type="email" class="form-control " id="edit_email" name="email" required>
                                </div>

                                <div class="mb-3">
                                    <label for="edit_userRoles" class="form-label">Roles</label>
                                    <select name="roles" id="edit_userRoles" class="form-select" multiple>
                                        {{ range .roles }}
                                            <option value="{{ .Name }}">{{ .Name }}</option>
                                        {{ end }}
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="edit_nip" class="form-label">Nomor Identitas Pegawai</label>
                                    <input type="text" class="form-control " id="edit_nip" name="nip" placeholder="Masukkan NIP/NIK Pegawai">
                                </div>

                                <div class="mb-3">
                                    <label for="edit_store_id" class="form-label">Outlet MK</label>
                                    <select id="edit_store_id" class="form-select " name="store_id" multiple required>
                                        {{ range .stores }}
                                            <option value="{{ .StoreID }}">{{ .StoreName }}</option>
                                        {{ end }}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="edit_status" class="form-label">Aktif</label>
                                    <select id="edit_status" class="form-select" name="status">
                                        <option value="active">Aktif</option>
                                        <option value="non_active">Non Aktif</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >Batal</button>
                        <button type="submit" class="btn btn-primary">
                            Update
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <!-- JAVASCRIPT -->
        <script src="/assets/libs/jquery/jquery.min.js"></script>
        <script src="/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="/assets/libs/metismenu/metisMenu.min.js"></script>
        <script src="/assets/libs/simplebar/simplebar.min.js"></script>
        <script src="/assets/libs/node-waves/waves.min.js"></script>

        <!-- apexcharts -->
        <script src="/assets/libs/apexcharts/apexcharts.min.js"></script>

        <!-- dashboard init -->
        <script src="/assets/js/pages/dashboard.init.js"></script>

        <!-- Sweet Alerts js -->
        <script src="/assets/libs/sweetalert2/sweetalert2.min.js"></script>

        <!-- Sweet alert init js-->
        <script src="/assets/js/pages/sweet-alerts.init.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var deleteButtons = document.querySelectorAll('.btn-delete-user');
                deleteButtons.forEach(function (btn) {
                    btn.addEventListener('click', function (event) {
                        event.preventDefault();
                        var username = btn.getAttribute('data-username') || 'user';
                        var targetUrl = btn.getAttribute('data-url');

                        Swal.fire({
                            title: 'Hapus user ini?',
                            text: 'User ' + username + ' akan dihapus secara permanen.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: 'Ya, hapus',
                            cancelButtonText: 'Batal'
                        }).then(function (result) {
                            if (result.isConfirmed && targetUrl) {
                                window.location.href = targetUrl;
                            }
                        });
                    });
                });

                var editButtons = document.querySelectorAll('.btn-edit-user');
                var editModalEl = document.getElementById('userEditModal');
                var editModal = (typeof bootstrap !== 'undefined' && editModalEl) ? new bootstrap.Modal(editModalEl) : null;

                function parseListAttr(val) {
                    if (!val) return [];
                    return val.split(',').map(function (item) {
                        return item.trim();
                    }).filter(Boolean);
                }

                function setMultiSelect(selectEl, values) {
                    if (!selectEl) return;
                    var lookup = new Set(values);
                    Array.from(selectEl.options).forEach(function (opt) {
                        opt.selected = lookup.has(opt.value);
                    });
                }

                editButtons.forEach(function (btn) {
                    btn.addEventListener('click', function () {
                        if (!editModalEl) {
                            return;
                        }

                        var idInput = editModalEl.querySelector('#edit_user_id');
                        var nameInput = editModalEl.querySelector('#edit_name');
                        var usernameInput = editModalEl.querySelector('#edit_username');
                        var passwordInput = editModalEl.querySelector('#edit_userPassword');
                        var emailInput = editModalEl.querySelector('#edit_email');
                        var nipInput = editModalEl.querySelector('#edit_nip');
                        var statusSelect = editModalEl.querySelector('#edit_status');
                        var roleSelect = editModalEl.querySelector('#edit_userRoles');
                        var storeSelect = editModalEl.querySelector('#edit_store_id');

                        if (idInput) idInput.value = btn.getAttribute('data-user-id') || '';
                        if (nameInput) nameInput.value = btn.getAttribute('data-name') || '';
                        if (usernameInput) usernameInput.value = btn.getAttribute('data-username') || '';
                        if (passwordInput) passwordInput.value = '';
                        if (emailInput) emailInput.value = btn.getAttribute('data-email') || '';
                        if (nipInput) nipInput.value = btn.getAttribute('data-nip') || '';
                        if (statusSelect) statusSelect.value = btn.getAttribute('data-status') || 'active';

                        setMultiSelect(roleSelect, parseListAttr(btn.getAttribute('data-roles')));
                        setMultiSelect(storeSelect, parseListAttr(btn.getAttribute('data-stores')));

                        if (editModal) {
                            editModal.show();
                        } else {
                            editModalEl.classList.add('show');
                            editModalEl.style.display = 'block';
                        }
                    });
                });
            });
        </script>

        <!-- App js -->
        <script src="/assets/js/app.js"></script>
    </body>
</html>
